<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta http-equiv="X-UA-COMPATIBLE">
    <title></title>
    <link href="https://fonts.cdnfonts.com/css/roboto" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Antique&display=swap" rel="stylesheet">
 
    </script>
    <script src="./vue.global.js"></script>
    <style>
        .zen-antique-regular {
            font-family: "Zen Antique", serif;
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'QiushuiShotai';
            font-weight: 600;
            src: url('/QiushuiShotai.otf') format('opentype');
            font-display: swap;
        }
        /* 
     

        @font-face {
            font-family: 'FOTMatisseProN';
            font-weight: 600;
            src: url('/Pro-M.otf') format('opentype');
            font-display: swap;
        } */

        * {
            box-sizing: border-box;
            padding: 0;
            margin: 0;
        }
        html,
        body {
            width: 100vw;
            height: 100%;
            color: #88ada6;
            background: black;
            font-size: 22px;
            font-family: "QiushuiShotai";
            overflow: hidden;
        }

        #app {
            position: relative;
            height: 100%;
            overflow: hidden;
            padding: 12px 8px;
        }

        .word-info {
            font-size: 14px;
            height: 30px;
        }

        .word-container {
            position: relative;
            margin-top: 16px;
            height: calc(100% - 150px);
            overflow-y: scroll;
            border-radius: 8px;
            background: #161823;
            color: #fffbf0;
            padding-bottom: 100px;
        }

        .question {
            font-size: 26px;
            line-height: 28px;
            color: #88ada6;
            text-align: left;
            font-weight: 400;
            font-style: normal;
            
            padding: 8px;
        }

        .question-item {
            color: burlywood;
        }

        .answer {

            position: relative;
            font-size: 26px;
            line-height: 28px;
            text-align: left;
            color: beige;
            
            font-weight: 400;
            font-style: normal;
            padding: 8px;
        }

 
        .comment {
            position: relative;
           
            margin-top: 8px;
            padding-left: 8px;
            font-family: "QiushuiShotai";
            font-weight: 400;
            font-style: normal;
        }

        .comment-item {
            color: #88ada6;
            font-size: 26px;
            line-height: 28px;
            margin-top: 10px;
            margin-bottom: 10px;
            text-align: left;
        }

        .action-wrap {
            position: absolute;
            bottom: 5px;
            left: 8px;
            height: 80px;
            width: calc(100% - 16px);
            display: flex;
            justify-content: space-around;
        }
        .action-next {
            width: 40%;
            background: rgba(136, 173, 166,0.4);
            color: beige;
            border-radius: 10px;
            text-align: center;
            height: 100%;
            line-height: 80px;
            font-size: 30px;

        }
        .level-select {
            bottom: 10px;
            display: flex;
            position: relative;
            width: 100%;
            height: 100%;
            font-weight: bold;
            font-size: 30px;
            justify-content: space-between;
        }

        .level-select-option {
            margin-left: 5px;
            margin-right: 5px;
            flex-grow: 1;
            flex-shrink: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            max-width: 40%;
            border-radius: 5px;
            color: black;
            background: rebeccapurple;
        }

        .action-hard {
            background-color: rgb(149, 18, 18);
        }
        .action-easy {
            background-color: rgb(95, 198, 95);
        }
  
        #myAudio {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
            visibility: hidden;
        }
    </style>
</head>

<body><audio id="myAudio"></audio><div id="app">
        <div class="word-info">
            &nbsp;&nbsp;{{learned}} / {{databaseLength}} &nbsp;&nbsp;
            üòî{{hard}}&nbsp;&nbsp;üòÄ{{easy}}
        </div>
        <div class="word-container"  @click="showNextField" >
                <div class="question" v-if="(showStep >= 0 && curWord.q)"  >
                    <div class="question-item" v-for="(questionItem, i) in curWord.q.split('„ÄÇ')" @click.prevent.stop="playAudio(questionItem)" >
                        {{questionItem}}
                    </div>
                </div>
                <div class="answer " v-if="(showStep >= 1 && curWord.a) "   >
                    <div class="answer-item" v-for="(answerItem, j) in curWord.a.split('„ÄÇ')" @click.prevent.stop="playAudio(answerItem)" >
                        {{answerItem}}
                    </div>
                </div>
                <div class="comment"
                    v-show="
                    (showStep >= 2) && curWord.sentences && (curWord.sentences.length > 0) ">
                    <div class="comment-item" v-for="(item, index) in curWord.sentences" @click.prevent.stop="playAudio(item)" v-html="formattedText(item)" >
                    </div>
                </div>
        </div>
        <div class="action-wrap">
            <div class="level-select" >
                <div class="level-select-option action-hard" @click="updateCurdWord(3)">Â§ßÂ§â</div>
                <div class="level-select-option action-easy" @click="updateCurdWord(1)">‰∏äÊâã</div>
                <!-- <div class="level-select-option " @click="playVoice"  >Áô∫Èü≥</div> -->
                <!-- <div class="level-select-option " 
                @click="showNextField">next</div> -->
            </div>
        </div>
    </div>
    </div>
    <script>
        const DATA_VERSION = "125"
        // const isJapaneseSentence = (text) => {
        //     if(!text || text.length == 0) {
        //         return false;
        //     }
        //     const length = text.length;
        //     const regex = /[\u3040-\u309f\u30a0-\u30ff]/g;
        //     let chineseCharsLength = (text.match(regex) || []).length; 
        //     console.log("length =",length)
        //     console.log("chineseCharsLength =",chineseCharsLength)

        //     return (chineseCharsLength > 1) && (length - chineseCharsLength) < 5
        // }

        // const testString = 'Hello, „Åì„Çì„Å´„Å°„ÅØ‰∏ñÁïåÊó•Êú¨Ë™ûÔºÅ';
        // console.log(isJapaneseSentence(testString));

        const LEVEL_NUM = {
            unread: 0,
            easy: 1,
            read: 2,
            hard: 3
        }
        const { createApp, ref } = Vue

        const app = createApp({

            data() {
                return {
                    recall:true,
                    learned: 0,
                    databaseLength: 0,
                    hard: 0,
                    readed: 0,
                    easy: 0,
                    curWord: {},
                    showStep: 0,
                    database: [],
                    test:"ÊºîÂ•è‰ºö„ÅØÁñæ„Å£„Åè„Å´Âßã„Åæ„Å£„Å¶„ÅÑ„Çã. ÂàáÁ¨¶„ÅØÁñæ„Å£„Åè„Å´Â£≤„ÇäÂàá„Çå„Åü„ÄÇ",
                    curWordLevel: LEVEL_NUM.read
                }
            },
            setup() {
                const  formattedText = (text) =>{
                    if(!text) return ''
                    return text.replace(".", "<br>").replace("„ÄÇ", "<br>").replace(" ", "");
                }
                return { formattedText };
            },
            mounted() {
                this.refreshinfotoolbar()
                this.inited()
            },
            methods: {
                playVoice() {
                    if( this.showStep == 0) {
                        this.playAudio(this.curWord.q)
                    } else if(this.showStep == 1) {
                        this.playAudio(this.curWord.a)
                    }
                },
                playAudio(text) {
                    let myaudio = document.getElementById('myAudio')
                    if (text) {
                        const voice = text.replace(/[\/Ôºè~„Äú]/gi, "„ÄÇ");

                        let msg = new SpeechSynthesisUtterance(voice);
                        msg.text = voice;     // ÊñáÂ≠óÂÜÖÂÆπ
                        msg.lang = "ja-JP";  // ‰ΩøÁî®ÁöÑËØ≠Ë®Ä:‰∏≠Êñá
                        //  window.speechSynthesis.speak(msg);
                        myaudio.pause()
                        myaudio.src = "https://dict.youdao.com/dictvoice?audio=" + voice + "&le=jap&type=3"
                        myaudio.play()
                        return;
                    }
                    if (this.curWord.q) {
                        myaudio.src = "audio/" + this.curWord.q;
                        myaudio.play()
                    }
                },
                initDB() {
                    let localDatabase = localStorage.getItem('gg_database')
                    const t = new Date().getTime();
                    if (localDatabase) {
                        localDatabase = JSON.parse(localDatabase)
                        if (Array.isArray(localDatabase)) {
                            if(this.databaseLength) {
                                // ÁºìÂ≠òÂíåÊï∞ÊçÆÂ∫ì‰∫íÁõ∏ÂêåÊ≠•ÔºåÂéªÊéâÂ∫üÂºÉÁöÑÂ¢ûÂä†Ê≤°ÊúâÁöÑ
                                const database_length = localDatabase.length;
                                for (let i = 0; i < this.databaseLength; i++) {
                                    for (let j = 0; j < database_length; j++) {
                                        if (this.database[i].q == localDatabase[j].q) {
                                            this.database[i].count = localDatabase[j].count;
                                            this.database[i].level = localDatabase[j].level;
                                            this.database[i].t = localDatabase[j].t;
                                            break;
                                        }
                                    }
                                }
                            } else {
                                this.database = localDatabase;
                                this.databaseLength = localDatabase.length;
                            }
                        }
                    }
                    localStorage.setItem('gg_database', JSON.stringify(this.database))
                    localStorage.setItem('data_version',DATA_VERSION)
                },
                refreshinfotoolbar() {
                    let learned = 0;
                    let easy = 0;
                    let hard = 0;
                    let readed = 0;

                    for (let i = 0; i < this.databaseLength; i++) {
                        if (this.database[i] && this.database[i].level != LEVEL_NUM.unread) {
                            learned = learned + 1;
                            if (this.database[i].level == LEVEL_NUM.hard) {
                                hard = hard + 1;
                            } else if (this.database[i].level == LEVEL_NUM.easy) {
                                easy = easy + 1;
                            } else if (this.database[i].level == LEVEL_NUM.read) {
                                readed = readed + 1;
                            }
                        }
                    }
                    this.learned = learned
                    this.easy = easy
                    this.hard = hard
                    this.readed = readed
                },
                inited() {
                    let dataVersion = localStorage.getItem('data_version')
                    if(dataVersion == DATA_VERSION) {
                        console.log('Êï∞ÊçÆÂ∑≤Âä†ËΩΩËøá')
                        this.initDB()
                        this.readWord()
                        this.refreshinfotoolbar()
                    } else {
                        this.readTxt()
                        console.log('ÊúâÊñ∞Êï∞ÊçÆ')
                    }
                },
                updateCurdWord(level) {
                    this.curWordLevel = level;
                    this.saveRecentHistory();
                    this.readWord()

                },
                showNextField() {
                    if((this.showStep >= 2) || (this.showStep == 1 && this.curWord.sentences.length <= 0) ) {
                        return
                    }
                    this.showStep = (this.showStep + 1) % 3;
                },
                saveRecentHistory() {
                    this.curWord.t = new Date().getTime();
                    this.curWord.level = this.curWordLevel;
                    this.curWord.count = this.curWord.count + 1;
                    for (let i = 0; i < this.databaseLength; i++) {
                        if (this.database[i].q == this.curWord.q) {
                            const t = new Date().getTime();
                            const level = this.curWord.level;
                            const count = this.curWord.count;
                            this.curWord.t = t;
                            this.curWord.level = level;
                            this.curWord.count = count;
                            this.database[i] = this.curWord;
                            break;
                        }
                    }
                    localStorage.setItem('gg_database', JSON.stringify(this.database))
                    this.refreshinfotoolbar()
                },
                readWord() {
                    this.curWord = {}
                    this.showStep = 2;
                    // ÈöèÊú∫Á≠ñÁï• 0ÔΩûÔΩû9 
                    // 1 2 ÂÆπÊòì
                    // 3 7 ÂæàÈöæ
                    
                    const index = Math.floor(Math.random() * 10);
                    const curTimeStamp = new Date().getTime()
                    let filterArr = []
                    if (index == 1 || index == 2) { // ÁÆÄÂçï
                        filterArr = this.database.filter((item, index) => {
                            return (item.level == LEVEL_NUM.easy) && ((curTimeStamp - 3600000) > item.t)
                            // Ëá≥Â∞ë2ÂàÜÈíü
                        })
                    } else if (index > 2 && index <= 7) {
                        filterArr = this.database.filter((item, index) => {
                            return (item.level == LEVEL_NUM.hard) && ((curTimeStamp - 120000) > item.t)
                        })
                    }

                    if (filterArr.length >= 50) {
                        // ‰∏âÁßçÈöèÊú∫ÊñπÂºè
                        // 0 ÈöèÊú∫50‰∏™ÊúÄ‰πÖËÉåËØµÊó∂Èó¥ÈáåÂèñ‰∏Ä‰∏™ 1 Êó∂Èó¥ÊúÄ‰πÖÈÇ£‰∏™ 2 ËÆ∞ÂæóÊ¨°Êï∞ÊúÄÂ∞ëÁöÑÈÇ£‰∏™
                        filterArr.sort((a, b) => {
                            return a.t - b.t;
                        });
                        let mod = Math.floor( Math.random() * 3 )
                        let = 0;
                        if(mod == 0) {
                           sortIndex = Math.floor(Math.random() * 50 );
                        } else if(mod == 1) {
                           sortIndex = 0
                        } else if(mod == 2 ) {
                            filterArr.sort((a, b) => {
                                return a.count - b.count;
                            });
                            sortIndex = 0
                        }
                        this.curWord = filterArr[sortIndex];
                    }
                    if (!this.curWord.q) {
                        let selectIndex = Math.floor(Math.random() * this.databaseLength);
                        this.curWord = this.database[selectIndex];
                        this.curWordLevel = this.curWord.level;
                    }
                    // this.playAudio(this.curWord.q)
                },
                readTxt() {
                    const self = this
                    fetch('./data.txt?v=' + DATA_VERSION )
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.text();
                        })
                        .then(text => {
                            let database = []
                            const ct = new Date().getTime()
                            text.split('\n').forEach((line) => {
                                if(line && line.length > 5 ) {
                                    const items = line.split('/');
                                    if (items.length >= 2) {
                                        database.push({
                                            q: items[0],
                                            a: items[1],
                                            sentences: items.slice(2),
                                            count: 0,
                                            level: 0,
                                            t: ct
                                        })
                                    }
                                }
                            });
            
                            self.database = database
                            self.databaseLength = database.length
                            self.initDB()
                            self.readWord()
                            self.refreshinfotoolbar()
                        })
                        .catch(error => {
                            console.error('There has been a problem with your fetch operation:', error);
                        });
                }
            }

        })
        app.mount('#app')
    </script>
</body>

</html>